version: '1.0'
kind: pipeline
metadata:
  name: ArgoCD/dev-express-canary-approval
  project: ArgoCD
  projectId: 5f36eeb80483afa451713a59
  revision: 26
  accountId: 5a3a2a445518610001637c87
  created_at: '2022-11-17T04:30:54.225Z'
  updated_at: '2023-02-22T17:51:10.299Z'
  shortName: dev-express-canary-approval
  deprecate: {}
  originalYamlString: |-
    version: "1.0"
    hooks:
      on_elected:
        exec:
          image: quay.io/codefresh/cli
          shell: bash
          commands:
            - |-
              export BUILD_STRATEGY=$(curl -X GET -H "Authorization: ${{CF_API_KEY}}" "${{CF_URL}}/api/builds/${{CF_BUILD_ID}}" | jq -r '.buildStrategy')
              echo $BUILD_STRATEGY    
              if [ "$BUILD_STRATEGY" == "restart-failed-steps" ] ; then
                  echo "Restarting from Failed Steps is NOT Permitted by Policy"
                  exit 1
              fi
            - codefresh get builds --pipeline-name=${{CF_PIPELINE_NAME}} -o json | jq -c '[ .[] | select( .status | contains("pending-approval")) | select( .["pipeline-trigger-id"] | contains("${{CF_PIPELINE_TRIGGER_ID}}")) | .id ]' |  jq -c '.[]' | xargs -n 1 codefresh terminate || echo "No Pending Builds Found."
    stages:
      - 'check canary'
      - 'canary 5%'
      - 'canary 50%'
      - finalize
    steps:
      check_canary_has_started:
        title: Checking Canary has Started...
        stage: 'check canary'
        image: quay.io/argoproj/kubectl-argo-rollouts:latest
        commands:
          - /bin/kubectl-argo-rollouts get rollout express-microservice -n istio-development --context codefreshdemo | grep Step | grep 1
        retry:
          maxAttempts: 5
          delay: 5
          exponentialFactor: 2
      check_canary_5:
        fail_fast: false
        type: pending-approval
        title: Is canary ok?
        stage: 'canary 5%'  
      promote_canary_50:
        title: Switching 50% traffic to canary
        stage: 'canary 50%'
        image: quay.io/argoproj/kubectl-argo-rollouts:latest
        commands:
          - /bin/kubectl-argo-rollouts promote express-microservice -n istio-development --context codefreshdemo
        when:
          steps:
          - name: check_canary_5
            on:
            - approved 
      abort_deployment_5:
        title: Discarding canary at 5%
        stage: 'canary 5%'
        image: quay.io/argoproj/kubectl-argo-rollouts:latest
        commands:
          - /bin/kubectl-argo-rollouts abort express-microservice -n istio-development --context codefreshdemo
        when:
          steps:
          - name: check_canary_5
            on:
            - denied         
      exit_5:
        title: Stopping pipeline
        stage: 'canary 5%'
        image: alpine:39
        commands:
          - echo "Canary failed"
          - exit 1
        when:
          steps:
          - name: check_canary_5
            on:
            - denied   
      check_canary_50:
        fail_fast: false
        type: pending-approval
        title: Is canary ok?
        stage: 'canary 50%'  
      promote_canary_full:
        title: Switching all traffic to canary
        stage: finalize
        image: quay.io/argoproj/kubectl-argo-rollouts:latest
        commands:
          - /bin/kubectl-argo-rollouts promote express-microservice --full -n istio-development --context codefreshdemo
        when:
          steps:
          - name: check_canary_50
            on:
            - approved 
      abort_deployment_50:
        title: Discarding canary at 50%
        stage: 'canary 50%'
        image: quay.io/argoproj/kubectl-argo-rollouts:latest
        commands:
          - /bin/kubectl-argo-rollouts abort express-microservice -n istio-development --context codefreshdemo
        when:
          steps:
          - name: check_canary_50
            on:
            - denied         
      exit_50:
        title: Stopping pipeline
        stage: 'canary 50%'
        image: alpine:39
        commands:
          - echo "Canary failed"
          - exit 1
        when:
          steps:
          - name: check_canary_50
            on:
            - denied        
  id: 6375b8fe40bd79d3a84a7a7c
spec:
  triggers:
    - name: codefresh-contrib/codefreshdemo-dev-manifests
      type: git
      repo: codefresh-contrib/codefreshdemo-dev-manifests
      events:
        - push.heads
      pullRequestAllowForkEvents: false
      commentRegex: /.*/gi
      branchRegex: /main/gi
      branchRegexInput: regex
      modifiedFilesGlob: kustomize/express-canary/**
      provider: github
      disabled: false
      options:
        noCache: false
        noCfCache: false
        resetVolume: false
      verified: true
      context: github
      contexts: []
      variables: []
      status: verified
      lastExecutionDate: '2023-02-27T21:34:41.555Z'
      id: 6375b8ff40bd7985af4a7a7d
      endpoint: 'https://g.codefresh.io/api/providers/github/hook/KFNaiJUgN4'
      secret: **************
  stages:
    - check canary
    - canary 5%
    - canary 50%
    - finalize
  variables: []
  contexts: []
  clustersInfo:
    injectAll: true
  debug:
    steps:
      check_canary_has_started:
        phases:
          before: false
          override: true
          after: false
  steps:
    check_canary_has_started:
      title: Checking Canary has Started...
      stage: check canary
      image: 'quay.io/argoproj/kubectl-argo-rollouts:latest'
      commands:
        - >-
          /bin/kubectl-argo-rollouts get rollout express-microservice -n
          istio-development --context codefreshdemo | grep Step | grep 1
      retry:
        maxAttempts: 5
        delay: 5
        exponentialFactor: 2
    check_canary_5:
      fail_fast: false
      type: pending-approval
      title: Is canary ok?
      stage: canary 5%
    promote_canary_50:
      title: Switching 50% traffic to canary
      stage: canary 50%
      image: 'quay.io/argoproj/kubectl-argo-rollouts:latest'
      commands:
        - >-
          /bin/kubectl-argo-rollouts promote express-microservice -n
          istio-development --context codefreshdemo
      when:
        steps:
          - name: check_canary_5
            'on':
              - approved
    abort_deployment_5:
      title: Discarding canary at 5%
      stage: canary 5%
      image: 'quay.io/argoproj/kubectl-argo-rollouts:latest'
      commands:
        - >-
          /bin/kubectl-argo-rollouts abort express-microservice -n
          istio-development --context codefreshdemo
      when:
        steps:
          - name: check_canary_5
            'on':
              - denied
    exit_5:
      title: Stopping pipeline
      stage: canary 5%
      image: 'alpine:39'
      commands:
        - echo "Canary failed"
        - exit 1
      when:
        steps:
          - name: check_canary_5
            'on':
              - denied
    check_canary_50:
      fail_fast: false
      type: pending-approval
      title: Is canary ok?
      stage: canary 50%
    promote_canary_full:
      title: Switching all traffic to canary
      stage: finalize
      image: 'quay.io/argoproj/kubectl-argo-rollouts:latest'
      commands:
        - >-
          /bin/kubectl-argo-rollouts promote express-microservice --full -n
          istio-development --context codefreshdemo
      when:
        steps:
          - name: check_canary_50
            'on':
              - approved
    abort_deployment_50:
      title: Discarding canary at 50%
      stage: canary 50%
      image: 'quay.io/argoproj/kubectl-argo-rollouts:latest'
      commands:
        - >-
          /bin/kubectl-argo-rollouts abort express-microservice -n
          istio-development --context codefreshdemo
      when:
        steps:
          - name: check_canary_50
            'on':
              - denied
    exit_50:
      title: Stopping pipeline
      stage: canary 50%
      image: 'alpine:39'
      commands:
        - echo "Canary failed"
        - exit 1
      when:
        steps:
          - name: check_canary_50
            'on':
              - denied
  hooks:
    on_elected:
      exec:
        image: quay.io/codefresh/cli
        shell: bash
        commands:
          - >-
            export BUILD_STRATEGY=$(curl -X GET -H "Authorization:
            ${{CF_API_KEY}}" "${{CF_URL}}/api/builds/${{CF_BUILD_ID}}" | jq -r
            '.buildStrategy')

            echo $BUILD_STRATEGY    

            if [ "$BUILD_STRATEGY" == "restart-failed-steps" ] ; then
                echo "Restarting from Failed Steps is NOT Permitted by Policy"
                exit 1
            fi
          - >-
            codefresh get builds --pipeline-name=${{CF_PIPELINE_NAME}} -o json |
            jq -c '[ .[] | select( .status | contains("pending-approval")) |
            select( .["pipeline-trigger-id"] |
            contains("${{CF_PIPELINE_TRIGGER_ID}}")) | .id ]' |  jq -c '.[]' |
            xargs -n 1 codefresh terminate || echo "No Pending Builds Found."

